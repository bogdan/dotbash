#!/usr/bin/ruby


require 'rubygems'
require "active_support/inflector"
require "optparse"


class Rsub

  def self.run(args)
    self.new(args).run
  end


  def initialize(args)

    opts = OptionParser.new do |opts|
      opts.banner = "Do git commit with information from pivotal story"
      opts.on("-o", "Only specified pattern") do
        @only = true
      end
    end
    opts.parse!(args)

    @old_name = args.shift
    @new_name = args.shift
    @path = args.join(" ")

  end

  def run
    pairs.each do |from, to|
      rename_files(from, to)
      replace(from, to)
    end
  end

  protected
  def pairs
    @pairs ||= 
      begin
        return {@old_name => @new_name} if @only
        result = {}
        [:pluralize, :singularize].each do |amount|
          [:underscore, :camelize].each do |wordcase|
            result[@old_name.send(wordcase).send(amount)] = @new_name.send(wordcase).send(amount)
          end
        end
        result
      end
  end

  def rename_files(from, to)
    
    files = exec("find #{@path} -name '#{from}*' ").split("\n")
    files.each do |old_name|
      new_name = old_name.gsub(from, to)
      exec "mv -v #{old_name} #{new_name}"
    end
  end
  
  def replace(from, to)
    exec "find #{@path} -type f -exec sed -i 's/#{from}/#{to}/g' {} \\;"
  end

  def exec(command)
    puts command
    `#{command}`
  end
end


Rsub.run(ARGV)

